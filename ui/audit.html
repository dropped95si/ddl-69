<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Performance Audit | DDL-69 • AGILEra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5b7cfa;
            --secondary: #3fd0c9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0b1220;
            --light: #121a2b;
            --text-hi: #eef2ff;
            --text-mid: #cbd5f5;
            --text-low: #93a4c6;
            --panel: rgba(16, 25, 43, 0.95);
            --panel-border: rgba(82, 100, 140, 0.35);
        }

        body {
            background: radial-gradient(circle at top left, #162038 0%, #0b1220 55%) fixed;
            min-height: 100vh;
            font-family: 'Sora', sans-serif;
            padding-top: 2rem;
            padding-bottom: 2rem;
            color: var(--text-hi);
        }

        .audit-hero {
            background: var(--panel);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(9, 13, 25, 0.5);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--panel-border);
        }

        .breadcrumb-fancy {
            background: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-fancy .breadcrumb-item {
            font-size: 0.9rem;
            color: var(--text-low);
        }

        .breadcrumb-fancy .breadcrumb-item a {
            color: var(--text-mid);
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-fancy .breadcrumb-item a:hover {
            color: var(--secondary);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--panel);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 12px 30px rgba(9, 13, 25, 0.45);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--panel-border);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(9, 13, 25, 0.55);
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-low);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .timeframe-filters {
            background: var(--panel);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 12px 30px rgba(9, 13, 25, 0.45);
            border: 1px solid var(--panel-border);
        }

        .chip-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chip {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 1px solid var(--panel-border);
            background: rgba(16, 25, 43, 0.9);
            color: var(--text-mid);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:hover {
            border-color: rgba(88, 110, 255, 0.6);
            color: var(--text-hi);
        }

        .chip.active {
            background: rgba(88, 110, 255, 0.2);
            border-color: rgba(88, 110, 255, 0.6);
            color: var(--text-hi);
        }

        .prediction-card {
            background: var(--panel);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 12px 30px rgba(9, 13, 25, 0.45);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--panel-border);
        }

        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(9, 13, 25, 0.55);
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .ticker-badge {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--text-hi);
        }

        .conviction-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .conviction-STRONG_BUY { background: #10b981; color: white; }
        .conviction-BUY { background: #3b82f6; color: white; }
        .conviction-HOLD { background: #f59e0b; color: white; }
        .conviction-PASS { background: #64748b; color: white; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric-box {
            text-align: center;
            padding: 0.75rem;
            background: rgba(10, 16, 30, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(82, 100, 140, 0.25);
        }

        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-low);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .targets-row {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .target-chip {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
        }

        .target-tp { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
        .target-sl { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }

        .reasoning-box {
            background: rgba(10, 16, 30, 0.85);
            border-left: 4px solid rgba(88, 110, 255, 0.6);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-mid);
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-low);
        }

        .footer-fancy {
            background: var(--panel);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
            border: 1px solid var(--panel-border);
        }

        .alert-strip {
            background: linear-gradient(90deg, rgba(142, 236, 210, 0.95), rgba(136, 213, 231, 0.95));
            color: #0b1220;
            padding: 10px 16px;
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 14px;
            margin-bottom: 1.5rem;
        }

        .alert-strip .alert-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert-strip .alert-pill {
            background: rgba(11, 18, 32, 0.15);
            border: 1px solid rgba(11, 18, 32, 0.25);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .parent-strip {
            background: rgba(255,255,255,0.9);
            border-radius: 14px;
            padding: 0.6rem 1rem;
            margin-bottom: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: #64748b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .parent-strip a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .parent-strip a:hover {
            color: var(--secondary);
        }

        .parent-strip .parent-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            border: 1px solid #e2e8f0;
            padding: 2px 8px;
            border-radius: 999px;
            color: #94a3b8;
        }

        .parent-strip .parent-current {
            color: var(--secondary);
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="alert-strip">
            <div>HIGH CONVICTION ALERTS</div>
            <div class="alert-pills">
                <span class="alert-pill" id="alertTicker1">--</span>
                <span class="alert-pill" id="alertTicker2">--</span>
                <span class="alert-pill" id="alertTicker3">--</span>
            </div>
        </div>
        <div class="parent-strip">
            <span class="parent-label">Parent</span>
            <a href="https://stazmediacorp.com" target="_blank" rel="noopener">stazmediacorp.com</a>
            <span>→</span>
            <a href="https://agilera.ai" target="_blank" rel="noopener">agilera.ai</a>
            <span>→</span>
            <a href="https://github.com/dropped95si/ddl-69" target="_blank" rel="noopener">github</a>
            <span>→</span>
            <span class="parent-current">ddl-69</span>
        </div>
        <!-- Hero Section -->
        <div class="audit-hero">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-fancy">
                    <li class="breadcrumb-item"><a href="https://stazmediacorp.com" target="_blank">stazmediacorp</a></li>
                    <li class="breadcrumb-item"><a href="https://agilera.ai" target="_blank">agilera</a></li>
                    <li class="breadcrumb-item"><a href="/">ddl-69</a></li>
                    <li class="breadcrumb-item active">audit</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="mb-2">
                        <i class="bi bi-graph-up-arrow text-primary"></i>
                        Model Performance Audit
                    </h1>
                    <p class="text-muted mb-0">Real predictions from DDL-69 Ensemble (MWU) • Live Supabase ML pipeline</p>
                </div>
                <div>
                    <a href="/watchlist" class="btn btn-outline-primary">
                        <i class="bi bi-eye"></i> Watchlist
                    </a>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="/api/status" class="btn btn-outline-primary" target="_blank" rel="noopener">
                        <i class="bi bi-database"></i> Supabase Status
                    </a>
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="stat-grid" id="summaryStats">
            <div class="stat-card">
                <div class="stat-label">Total Predictions</div>
                <div class="stat-value text-primary" id="statTotal">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Strong Buy</div>
                <div class="stat-value text-success" id="statStrongBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Buy</div>
                <div class="stat-value text-info" id="statBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Hold</div>
                <div class="stat-value text-warning" id="statHold">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Confidence</div>
                <div class="stat-value" id="statConfidence">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Expected Return</div>
                <div class="stat-value text-success" id="statReturn">--</div>
            </div>
        </div>

        <!-- Timeframe Filters -->
        <div class="timeframe-filters">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Timeframe Breakdown</h5>
                <span id="asofTime" class="text-muted small">--</span>
            </div>
            <div class="chip-group" id="timeframeChips">
                <button class="chip active" data-timeframe="all">All</button>
                <button class="chip" data-timeframe="day">Day (1-30d)</button>
                <button class="chip" data-timeframe="swing">Swing (1-12mo)</button>
                <button class="chip" data-timeframe="long">Long (1y+)</button>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    <strong>Day:</strong> 1-30 days • <strong>Swing:</strong> 31-365 days (1 month - 1 year) • <strong>Long:</strong> 366+ days (1+ years)
                </small>
            </div>
        </div>

        <!-- Predictions -->
        <div id="predictionsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-white" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-white mt-3">Loading audit data...</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-fancy">
            <p class="text-muted mb-2">
                <strong>Methodology:</strong> Real predictions from DDL-69 Ensemble using Multiplicative Weights Update (MWU). 
                Combines 6+ experts: TA, Events, Earnings, Whale Flow, Sentiment, Chronos-2.
            </p>
            <p class="text-muted mb-0">
                © 2026 <a href="https://stazmediacorp.com" target="_blank" class="text-decoration-none">Staz Media Corp LLC</a> • 
                Powered by <a href="https://agilera.ai" target="_blank" class="text-decoration-none">AGILEra</a> •
                <a href="https://github.com/dropped95si/ddl-69" target="_blank" class="text-decoration-none">github</a> •
                <a href="/api/status" target="_blank" class="text-decoration-none">supabase status</a>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allPredictions = [];
        let currentTimeframe = 'all';

        function fmtMoney(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return 'N/A';
            return num.toFixed(2);
        }
        
        async function loadAudit(timeframe = currentTimeframe) {
            try {
                currentTimeframe = timeframe || 'all';
                const endpoint = `/api/audit?limit=20&distinct_tickers=1&timeframe=${encodeURIComponent(currentTimeframe)}`;
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'API error');
                }
                
                allPredictions = data.predictions || [];
                
                // Update summary
                document.getElementById('statTotal').textContent = data.summary.total_predictions;
                document.getElementById('statStrongBuy').textContent = data.summary.strong_buy;
                document.getElementById('statBuy').textContent = data.summary.buy;
                document.getElementById('statHold').textContent = data.summary.hold;
                document.getElementById('statConfidence').textContent = (data.summary.avg_confidence * 100).toFixed(1) + '%';
                document.getElementById('statReturn').textContent = data.summary.avg_expected_return_pct.toFixed(2) + '%';
                
                // Update timestamp
                if (data.asof) {
                    const asof = new Date(data.asof);
                    document.getElementById('asofTime').textContent = `Updated: ${asof.toLocaleString()}`;
                }
                
                renderPredictions();
                const tickers = (data.predictions || []).map(p => p.ticker).filter(Boolean).slice(0, 3);
                document.getElementById('alertTicker1').textContent = tickers[0] || '--';
                document.getElementById('alertTicker2').textContent = tickers[1] || '--';
                document.getElementById('alertTicker3').textContent = tickers[2] || '--';
            } catch (error) {
                console.error('Error loading audit:', error);
                document.getElementById('predictionsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #fff;"></i>
                        <h4 class="mt-3 text-white">Error Loading Data</h4>
                        <p class="text-white">${error.message}</p>
                        <button class="btn btn-light mt-3" onclick="loadAudit()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function renderPredictions() {
            const filtered = allPredictions || [];
            
            if (filtered.length === 0) {
                document.getElementById('predictionsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #fff;"></i>
                        <h4 class="mt-3 text-white">No Predictions</h4>
                        <p class="text-white">No predictions for selected timeframe</p>
                    </div>
                `;
                return;
            }
            
            const html = filtered.map(pred => {
                const m = pred.metrics;
                const convictionClass = pred.conviction.replace(' ', '_');
                
                return `
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <div>
                                <div class="ticker-badge"><a href="https://www.tradingview.com/symbols/${encodeURIComponent(pred.ticker)}/" target="_blank" rel="noreferrer" style="color:inherit;text-decoration:none;">${pred.ticker}</a></div>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-currency-dollar"></i> ${fmtMoney(pred.price)} • 
                                    ${pred.timeframe_description}
                                </div>
                            </div>
                            <div class="conviction-badge conviction-${convictionClass}">
                                ${pred.conviction}
                            </div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-box">
                                <div class="metric-label">Confidence</div>
                                <div class="metric-value text-primary">${(m.confidence * 100).toFixed(1)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">P(Accept)</div>
                                <div class="metric-value text-success">${(m.p_accept * 100).toFixed(1)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Expected Return</div>
                                <div class="metric-value text-success">${m.expected_return_pct > 0 ? '+' : ''}${m.expected_return_pct.toFixed(2)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Risk/Reward</div>
                                <div class="metric-value">${m.risk_reward_ratio ? m.risk_reward_ratio.toFixed(2) + ':1' : 'N/A'}</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Sharpe Est.</div>
                                <div class="metric-value">${m.sharpe_estimate ? m.sharpe_estimate.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Days Remaining</div>
                                <div class="metric-value">${m.days_remaining}d</div>
                            </div>
                        </div>
                        
                        <div class="targets-row">
                            ${pred.targets.tp1 ? `<div class="target-chip target-tp">TP1: $${pred.targets.tp1.toFixed(2)}</div>` : ''}
                            ${pred.targets.tp3 ? `<div class="target-chip target-tp">TP3: $${pred.targets.tp3.toFixed(2)}</div>` : ''}
                            ${pred.targets.sl1 ? `<div class="target-chip target-sl">SL: $${pred.targets.sl1.toFixed(2)}</div>` : ''}
                        </div>
                        
                        <div class="reasoning-box">
                            <i class="bi bi-lightbulb"></i> ${pred.reasoning}
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Method:</strong> ${pred.model_details.method} • 
                                <strong>Experts:</strong> ${pred.model_details.num_experts} • 
                                <strong>Exit Target:</strong> ${m.target_exit_date}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('predictionsContainer').innerHTML = html;
        }
        
        // Timeframe filter
        document.getElementById('timeframeChips').addEventListener('click', (e) => {
            if (e.target.classList.contains('chip')) {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                currentTimeframe = e.target.dataset.timeframe;
                loadAudit(currentTimeframe);
            }
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadAudit);
        
        // Initial load
        loadAudit();
    </script>
</body>
</html>

