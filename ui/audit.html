<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Performance Audit | DDL-69 • AGILEra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .audit-hero {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .breadcrumb-fancy {
            background: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }
        
        .breadcrumb-fancy .breadcrumb-item {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .breadcrumb-fancy .breadcrumb-item a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .breadcrumb-fancy .breadcrumb-item a:hover {
            color: var(--secondary);
        }
       .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }
        
        .timeframe-filters {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        .chip-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .chip {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .prediction-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .ticker-badge {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--dark);
        }
        
        .conviction-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .conviction-STRONG_BUY { background: #10b981; color: white; }
        .conviction-BUY { background: #3b82f6; color: white; }
        .conviction-HOLD { background: #f59e0b; color: white; }
        .conviction-PASS { background: #64748b; color: white; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .metric-box {
            text-align: center;
            padding: 0.75rem;
            background: var(--light);
            border-radius: 12px;
        }
        
        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }
        
        .targets-row {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .target-chip {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
        }
        
        .target-tp { background: #d1fae5; color: #059669; }
        .target-sl { background: #fee2e2; color: #dc2626; }
        
        .reasoning-box {
            background: var(--light);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        
        .footer-fancy {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        @media (max-width: 768px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <div class="audit-hero">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-fancy">
                    <li class="breadcrumb-item"><a href="https://stazmediacorp.com" target="_blank">stazmediacorp</a></li>
                    <li class="breadcrumb-item"><a href="https://agilera.ai" target="_blank">agilera</a></li>
                    <li class="breadcrumb-item"><a href="/">ddl-69</a></li>
                    <li class="breadcrumb-item active">audit</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="mb-2">
                        <i class="bi bi-graph-up-arrow text-primary"></i>
                        Model Performance Audit
                    </h1>
                    <p class="text-muted mb-0">Real predictions from DDL-69 Ensemble (MWU) • Live Supabase ML pipeline</p>
                </div>
                <div>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </a>
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="stat-grid" id="summaryStats">
            <div class="stat-card">
                <div class="stat-label">Total Predictions</div>
                <div class="stat-value text-primary" id="statTotal">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Strong Buy</div>
                <div class="stat-value text-success" id="statStrongBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Buy</div>
                <div class="stat-value text-info" id="statBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Hold</div>
                <div class="stat-value text-warning" id="statHold">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Confidence</div>
                <div class="stat-value" id="statConfidence">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Expected Return</div>
                <div class="stat-value text-success" id="statReturn">--</div>
            </div>
        </div>

        <!-- Timeframe Filters -->
        <div class="timeframe-filters">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Timeframe Breakdown</h5>
                <span id="asofTime" class="text-muted small">--</span>
            </div>
            <div class="chip-group" id="timeframeChips">
                <button class="chip active" data-timeframe="all">All</button>
                <button class="chip" data-timeframe="day">Day (1-90d)</button>
                <button class="chip" data-timeframe="swing">Swing (3-6mo)</button>
                <button class="chip" data-timeframe="long">Long (6mo+)</button>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    <strong>Day:</strong> 1-90 days • <strong>Swing:</strong> 90-180 days (3-6 months) • <strong>Long:</strong> 180+ days (6+ months)
                </small>
            </div>
        </div>

        <!-- Predictions -->
        <div id="predictionsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-white" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-white mt-3">Loading audit data...</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-fancy">
            <p class="text-muted mb-2">
                <strong>Methodology:</strong> Real predictions from DDL-69 Ensemble using Multiplicative Weights Update (MWU). 
                Combines 6+ experts: TA, Events, Earnings, Whale Flow, Sentiment, Chronos-2.
            </p>
            <p class="text-muted mb-0">
                © 2026 <a href="https://stazmediacorp.com" target="_blank" class="text-decoration-none">Staz Media Corp LLC</a> • 
                Powered by <a href="https://agilera.ai" target="_blank" class="text-decoration-none">AGILEra</a>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allPredictions = [];
        let currentTimeframe = 'all';
        
        async function loadAudit() {
            try {
                const response = await fetch('/api/audit?limit=20');
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'API error');
                }
                
                allPredictions = data.predictions || [];
                
                // Update summary
                document.getElementById('statTotal').textContent = data.summary.total_predictions;
                document.getElementById('statStrongBuy').textContent = data.summary.strong_buy;
                document.getElementById('statBuy').textContent = data.summary.buy;
                document.getElementById('statHold').textContent = data.summary.hold;
                document.getElementById('statConfidence').textContent = (data.summary.avg_confidence * 100).toFixed(1) + '%';
                document.getElementById('statReturn').textContent = data.summary.avg_expected_return_pct.toFixed(2) + '%';
                
                // Update timestamp
                if (data.asof) {
                    const asof = new Date(data.asof);
                    document.getElementById('asofTime').textContent = `Updated: ${asof.toLocaleString()}`;
                }
                
                renderPredictions();
            } catch (error) {
                console.error('Error loading audit:', error);
                document.getElementById('predictionsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #fff;"></i>
                        <h4 class="mt-3 text-white">Error Loading Data</h4>
                        <p class="text-white">${error.message}</p>
                        <button class="btn btn-light mt-3" onclick="loadAudit()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function renderPredictions() {
            const filtered = currentTimeframe === 'all' 
                ? allPredictions 
                : allPredictions.filter(p => p.timeframe === currentTimeframe);
            
            if (filtered.length === 0) {
                document.getElementById('predictionsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #fff;"></i>
                        <h4 class="mt-3 text-white">No Predictions</h4>
                        <p class="text-white">No predictions for selected timeframe</p>
                    </div>
                `;
                return;
            }
            
            const html = filtered.map(pred => {
                const m = pred.metrics;
                const convictionClass = pred.conviction.replace(' ', '_');
                
                return `
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <div>
                                <div class="ticker-badge">${pred.ticker}</div>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-currency-dollar"></i> ${pred.price.toFixed(2)} • 
                                    ${pred.timeframe_description}
                                </div>
                            </div>
                            <div class="conviction-badge conviction-${convictionClass}">
                                ${pred.conviction}
                            </div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-box">
                                <div class="metric-label">Confidence</div>
                                <div class="metric-value text-primary">${(m.confidence * 100).toFixed(1)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">P(Accept)</div>
                                <div class="metric-value text-success">${(m.p_accept * 100).toFixed(1)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Expected Return</div>
                                <div class="metric-value text-success">${m.expected_return_pct > 0 ? '+' : ''}${m.expected_return_pct.toFixed(2)}%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Risk/Reward</div>
                                <div class="metric-value">${m.risk_reward_ratio ? m.risk_reward_ratio.toFixed(2) + ':1' : 'N/A'}</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Sharpe Est.</div>
                                <div class="metric-value">${m.sharpe_estimate ? m.sharpe_estimate.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Days Remaining</div>
                                <div class="metric-value">${m.days_remaining}d</div>
                            </div>
                        </div>
                        
                        <div class="targets-row">
                            ${pred.targets.tp1 ? `<div class="target-chip target-tp">TP1: $${pred.targets.tp1.toFixed(2)}</div>` : ''}
                            ${pred.targets.tp3 ? `<div class="target-chip target-tp">TP3: $${pred.targets.tp3.toFixed(2)}</div>` : ''}
                            ${pred.targets.sl1 ? `<div class="target-chip target-sl">SL: $${pred.targets.sl1.toFixed(2)}</div>` : ''}
                        </div>
                        
                        <div class="reasoning-box">
                            <i class="bi bi-lightbulb"></i> ${pred.reasoning}
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Method:</strong> ${pred.model_details.method} • 
                                <strong>Experts:</strong> ${pred.model_details.num_experts} • 
                                <strong>Exit Target:</strong> ${m.target_exit_date}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('predictionsContainer').innerHTML = html;
        }
        
        // Timeframe filter
        document.getElementById('timeframeChips').addEventListener('click', (e) => {
            if (e.target.classList.contains('chip')) {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                currentTimeframe = e.target.dataset.timeframe;
                renderPredictions();
            }
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadAudit);
        
        // Initial load
        loadAudit();
    </script>
</body>
</html>
