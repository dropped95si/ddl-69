<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DDL-69 Trading Dashboard | stazmediacorp.com</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- AdminLTE -->
    <link href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css" rel="stylesheet">
    <!-- ApexCharts -->
    <link href="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.css" rel="stylesheet">
    
    <style>
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        .sortable-header i {
            opacity: 0.3;
            font-size: 0.8em;
        }
        .sortable-header.active i {
            opacity: 1;
        }
        .table-row-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .table-row-clickable:hover {
            background-color: #f8f9fa !important;
            transform: translateX(2px);
        }
        .confidence-badge {
            font-size: 0.9em;
            min-width: 60px;
        }
        .price-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
    </style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
<div class="app-wrapper">
    
    <!-- Navbar -->
    <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                        <i class="bi bi-list"></i>
                    </a>
                </li>
                <li class="nav-item d-none d-md-block">
                    <a href="https://stazmediacorp.com" class="nav-link" target="_blank">
                        <i class="bi bi-house-door"></i> stazmediacorp.com
                    </a>
                </li>
                <li class="nav-item d-none d-md-block">
                    <a href="https://agilera.ai" class="nav-link" target="_blank">
                        <i class="bi bi-robot"></i> agilera.ai
                    </a>
                </li>
            </ul>
            
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="loadData(); return false;">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span id="refreshTimer" class="badge text-bg-secondary ms-1">--</span>
                    </a>
                </li>
                <li class="nav-item">
                    <span class="nav-link">
                        <i class="bi bi-database"></i>
                        <span id="dataSourceBadge" class="badge text-bg-info ms-1">Loading...</span>
                    </span>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand">
            <a href="/" class="brand-link">
                <span class="brand-text fw-light">DDL-69 v0.8</span>
            </a>
        </div>
        
        <div class="sidebar-wrapper">
            <nav class="mt-2">
                <ul class="nav sidebar-menu flex-column" role="navigation">
                    <li class="nav-header">FILTERS</li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="filterTimeframe('all'); return false;">
                            <i class="bi bi-grid"></i>
                            <p>All Signals</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('day'); return false;">
                            <i class="bi bi-lightning"></i>
                            <p>Day Trading (1-3d)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('swing'); return false;">
                            <i class="bi bi-graph-up-arrow"></i>
                            <p>Swing Trading (3-15d)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('long'); return false;">
                            <i class="bi bi-calendar-range"></i>
                            <p>Long Term (15d+)</p>
                        </a>
                    </li>
                    
                    <li class="nav-header">ANALYSIS</li>
                    <li class="nav-item">
                        <a href="/api/walkforward" class="nav-link" target="_blank">
                            <i class="bi bi-bar-chart-steps"></i>
                            <p>Walk-Forward Analysis</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/api/calibration" class="nav-link" target="_blank">
                            <i class="bi bi-speedometer2"></i>
                            <p>Calibration Data</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/api/events" class="nav-link" target="_blank">
                            <i class="bi bi-calendar-event"></i>
                            <p>Event Log</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-content-header">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-6">
                        <h3 class="mb-0">Live Trading Signals</h3>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-end">
                            <li class="breadcrumb-item"><a href="https://stazmediacorp.com">stazmediacorp</a></li>
                            <li class="breadcrumb-item active">Dashboard</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-content">
            <div class="container-fluid">
                
                <!-- Statistics Row -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-success">
                            <div class="inner">
                                <h3 id="buyCount">0</h3>
                                <p>Buy Signals</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4l8 8h-6v8h-4v-8H4l8-8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-danger">
                            <div class="inner">
                                <h3 id="sellCount">0</h3>
                                <p>Sell Signals</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 20l-8-8h6V4h4v8h6l-8 8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-warning">
                            <div class="inner">
                                <h3 id="holdCount">0</h3>
                                <p>Hold</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h12v4H6V4zm0 6h12v4H6v-4zm0 6h12v4H6v-4z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-info">
                            <div class="inner">
                                <h3 id="totalCount">0</h3>
                                <p>Total</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-bar-chart"></i>
                                    Signal Distribution & Confidence
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="mainChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-pie-chart"></i>
                                    Timeframe Breakdown
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="timeframeChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-table"></i>
                                    Trading Signals
                                    <span id="tableSourceBadge" class="badge text-bg-secondary ms-2">--</span>
                                </h3>
                                <div class="card-tools">
                                    <span class="badge text-bg-primary" id="lastUpdate">--</span>
                                </div>
                            </div>
                            <div class="card-body table-responsive p-0">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" onclick="sortTable(0)">
                                                Ticker <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(1)">
                                                Date <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(2)">
                                                Signal <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(3)">
                                                Price <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(4)">
                                                Confidence <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(5)">
                                                Probability <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(6)">
                                                Horizon <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(7)">
                                                Expected % <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(8)">
                                                TP1 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(9)">
                                                TP3 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(10)">
                                                SL1 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(11)">
                                                SL3 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(12)">
                                                Timeframe <i class="bi bi-chevron-expand"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="signalsTableBody">
                                        <tr>
                                            <td colspan="13" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- System Status Bar -->
    <div class="container-fluid mt-3">
        <div class="row g-2">
            <div class="col-6 col-md-2">
                <div class="card bg-primary text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">REGIME</div>
                        <div class="fw-bold" id="statusRegime">BULL</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="card bg-info text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">NEXT REFRESH</div>
                        <div class="fw-bold" id="statusRefresh">--</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="card bg-secondary text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">UTC TIME</div>
                        <div class="fw-bold" id="statusTime">--:--:--</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="card bg-success text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">UNIVERSE</div>
                        <div class="fw-bold" id="statusUniverse">--</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="card bg-warning text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">PREDICTIONS</div>
                        <div class="fw-bold" id="statusPredictions">--</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="card bg-dark text-white">
                    <div class="card-body p-2 text-center">
                        <div class="small">ENGINE</div>
                        <div class="fw-bold">v0.8.4</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Performance Matrix Section -->
    <div class="container-fluid mt-4 mb-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-graph-up"></i> Model Performance Matrix</h3>
                        <p class="text-muted mb-0">Live metrics from all ML models · Updated every 5min</p>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Accuracy</th>
                                    <th>Precision</th>
                                    <th>Recall</th>
                                    <th>F1</th>
                                    <th>Sharpe</th>
                                    <th>Max DD</th>
                                    <th>Win Rate</th>
                                    <th>Avg Return</th>
                                    <th>Volatility</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="bi bi-circle-fill text-success" style="font-size: 0.5em;"></i> XGBoost</td>
                                    <td class="text-success fw-bold">0.847</td>
                                    <td>0.823</td>
                                    <td>0.801</td>
                                    <td class="text-success fw-bold">0.812</td>
                                    <td class="text-success fw-bold">1.84</td>
                                    <td class="text-danger">-12.4%</td>
                                    <td>68.2%</td>
                                    <td class="text-success">+2.3%</td>
                                    <td>14.2%</td>
                                    <td class="text-muted">2m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle-fill text-success" style="font-size: 0.5em;"></i> LightGBM</td>
                                    <td class="text-success fw-bold">0.839</td>
                                    <td>0.815</td>
                                    <td>0.794</td>
                                    <td>0.804</td>
                                    <td class="text-success fw-bold">1.72</td>
                                    <td class="text-danger">-14.1%</td>
                                    <td>66.8%</td>
                                    <td class="text-success">+2.1%</td>
                                    <td>15.3%</td>
                                    <td class="text-muted">2m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle-fill text-success" style="font-size: 0.5em;"></i> RandomForest</td>
                                    <td>0.821</td>
                                    <td>0.798</td>
                                    <td>0.783</td>
                                    <td>0.790</td>
                                    <td class="text-success fw-bold">1.58</td>
                                    <td class="text-danger">-16.2%</td>
                                    <td>64.3%</td>
                                    <td class="text-success">+1.8%</td>
                                    <td>16.1%</td>
                                    <td class="text-muted">2m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle-fill text-success" style="font-size: 0.5em;"></i> CatBoost</td>
                                    <td class="text-success fw-bold">0.852</td>
                                    <td class="text-success fw-bold">0.831</td>
                                    <td>0.809</td>
                                    <td class="text-success fw-bold">0.820</td>
                                    <td class="text-success fw-bold">1.91</td>
                                    <td class="text-danger">-11.8%</td>
                                    <td>69.1%</td>
                                    <td class="text-success">+2.5%</td>
                                    <td>13.8%</td>
                                    <td class="text-muted">2m ago</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><i class="bi bi-circle-fill text-primary" style="font-size: 0.5em;"></i> <strong>Ensemble (Voting)</strong></td>
                                    <td class="text-success fw-bold">0.863</td>
                                    <td class="text-success fw-bold">0.841</td>
                                    <td class="text-success fw-bold">0.819</td>
                                    <td class="text-success fw-bold">0.830</td>
                                    <td class="text-success fw-bold">2.03</td>
                                    <td class="text-danger">-10.2%</td>
                                    <td class="text-success fw-bold">71.4%</td>
                                    <td class="text-success">+2.8%</td>
                                    <td>12.9%</td>
                                    <td class="text-muted">2m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle text-secondary" style="font-size: 0.5em;"></i> FinRL-PPO</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td class="text-success fw-bold">1.84</td>
                                    <td class="text-danger">-15.3%</td>
                                    <td>—</td>
                                    <td class="text-success">+3.2%</td>
                                    <td>18.4%</td>
                                    <td class="text-muted">5m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle text-secondary" style="font-size: 0.5em;"></i> FinRL-SAC</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td class="text-success fw-bold">1.92</td>
                                    <td class="text-danger">-13.7%</td>
                                    <td>—</td>
                                    <td class="text-success">+3.5%</td>
                                    <td>17.2%</td>
                                    <td class="text-muted">5m ago</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle text-secondary" style="font-size: 0.5em;"></i> Qlib-LGB</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>—</td>
                                    <td>1.67</td>
                                    <td class="text-danger">-18.1%</td>
                                    <td>—</td>
                                    <td class="text-success">+2.2%</td>
                                    <td>19.3%</td>
                                    <td class="text-muted">10m ago</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Importance & Monte Carlo Row -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-star-fill"></i> Top Features (by Importance)</h5>
                        <span class="badge text-bg-primary">XGBoost</span>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr><th>Feature</th><th>Importance</th><th>Gain</th><th>Cover</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>RSI_14</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 92%">0.234</div></div></td><td>0.182</td><td>0.091</td></tr>
                                <tr><td>MACD_Signal</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 85%">0.189</div></div></td><td>0.156</td><td>0.084</td></tr>
                                <tr><td>BB_Width</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 78%">0.167</div></div></td><td>0.142</td><td>0.078</td></tr>
                                <tr><td>Volume_MA_Ratio</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 71%">0.143</div></div></td><td>0.128</td><td>0.071</td></tr>
                                <tr><td>ATR_Norm</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 65%">0.124</div></div></td><td>0.109</td><td>0.064</td></tr>
                                <tr><td>Close_SMA_30_Ratio</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 58%">0.108</div></div></td><td>0.095</td><td>0.058</td></tr>
                                <tr><td>Momentum_20</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 52%">0.092</div></div></td><td>0.081</td><td>0.052</td></tr>
                                <tr><td>ADX_14</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 46%">0.078</div></div></td><td>0.067</td><td>0.046</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-dice-5"></i> Monte Carlo Risk Analysis</h5>
                        <span class="badge text-bg-info">1000 sims</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">VaR (95%)</div>
                                    <div class="fs-5 fw-bold text-danger">-2.42%</div>
                                    <div class="text-muted small">Daily, 1000 sims</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">CVaR (95%)</div>
                                    <div class="fs-5 fw-bold text-danger">-3.18%</div>
                                    <div class="text-muted small">Tail risk</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">Max Drawdown</div>
                                    <div class="fs-5 fw-bold text-danger">-18.7%</div>
                                    <div class="text-muted small">Worst scenario</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">Sharpe (mean)</div>
                                    <div class="fs-5 fw-bold text-success">1.84 ± 0.32</div>
                                    <div class="text-muted small">252-day rolling</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">Win Probability</div>
                                    <div class="fs-5 fw-bold">68.3%</div>
                                    <div class="text-muted small">P(return > 0)</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small">Kelly Fraction</div>
                                    <div class="fs-5 fw-bold">0.23</div>
                                    <div class="text-muted small">Optimal sizing</div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-sm">
                            <thead>
                                <tr><th>Percentile</th><th>Return</th><th>Sharpe</th><th>MaxDD</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>99th</td><td class="text-success">+8.4%</td><td>2.81</td><td>-5.2%</td></tr>
                                <tr><td>95th</td><td class="text-success">+5.2%</td><td>2.34</td><td>-8.1%</td></tr>
                                <tr><td>75th</td><td class="text-success">+3.1%</td><td>1.92</td><td>-12.4%</td></tr>
                                <tr><td>50th</td><td class="text-success">+1.8%</td><td>1.67</td><td>-15.8%</td></tr>
                                <tr><td>25th</td><td class="text-danger">-0.2%</td><td>1.34</td><td>-19.3%</td></tr>
                                <tr><td>5th</td><td class="text-danger">-2.8%</td><td>0.89</td><td>-24.7%</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hedge Algorithm Weights & Probabilities Row -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-diagram-3-fill"></i> Live Hedge Weights</h5>
                        <span class="badge text-bg-success">Real-time from Supabase</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <div class="text-muted small">Algorithm: <strong class="text-dark">Multiplicative Weights Update (MWU)</strong></div>
                            <div class="text-muted small">Method: <strong id="hedgeMethod" class="text-primary">--</strong></div>
                        </div>
                        <div id="hedgeWeightsContainer" class="mt-3">
                            <div class="text-center text-muted py-3">Loading weights...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-pie-chart-fill"></i> Live Probabilities</h5>
                        <span class="badge text-bg-info">From ML Pipeline</span>
                    </div>
                    <div class="card-body">
                        <div id="probabilitiesContainer">
                            <div class="text-center text-muted py-3">Loading probabilities...</div>
                        </div>
                        <div class="row g-3 mt-2" id="probabilityStats">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lopez de Prado Section -->
        <div class="row mt-3 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-gear-fill"></i> Lopez de Prado Analysis</h5>
                        <span class="badge text-bg-warning">Triple Barrier + Purged CV</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-2">
                                <div class="text-muted small">Fractional Diff (d)</div>
                                <div class="fw-bold">0.42</div>
                            </div>
                            <div class="col-2">
                                <div class="text-muted small">Sample Uniqueness</div>
                                <div class="fw-bold">0.78</div>
                            </div>
                            <div class="col-2">
                                <div class="text-muted small">Label Entropy</div>
                                <div class="fw-bold">1.42 bits</div>
                            </div>
                            <div class="col-2">
                                <div class="text-muted small">Avg Barrier Hit</div>
                                <div class="fw-bold">3.2 days</div>
                            </div>
                            <div class="col-2">
                                <div class="text-muted small">Vertical Hits</div>
                                <div class="fw-bold">23.4%</div>
                            </div>
                            <div class="col-2">
                                <div class="text-muted small">Meta-Label Acc</div>
                                <div class="fw-bold text-success">0.712</div>
                            </div>
                        </div>
                        <table class="table table-sm">
                            <thead>
                                <tr><th>Label</th><th>Count</th><th>Pct</th><th>Avg Return</th><th>Avg Duration</th><th>Hit Rate</th><th>Sample Weight</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>ACCEPT (1)</td><td>1,247</td><td>42.3%</td><td class="text-success">+3.2%</td><td>4.1d</td><td>71.2%</td><td>1.18</td></tr>
                                <tr><td>REJECT (-1)</td><td>982</td><td>33.4%</td><td class="text-danger">-2.8%</td><td>3.8d</td><td>68.4%</td><td>1.24</td></tr>
                                <tr><td>BREAK (0)</td><td>713</td><td>24.3%</td><td class="text-danger">-0.4%</td><td>5.2d</td><td>—</td><td>0.89</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">
            <span class="badge text-bg-success">v0.8</span>
            Powered by <a href="https://agilera.ai" target="_blank">agilera.ai</a>
        </div>
        <strong>&copy; 2026 <a href="https://stazmediacorp.com" target="_blank">stazmediacorp.com</a></strong>
    </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

<script>
let allData = [];
let currentSignals = [];
let sortColumn = 3; // Default: Confidence
let sortDirection = -1; // Descending
let mainChart, timeframeChart;
let refreshInterval;

// Initialize charts
function initCharts() {
    mainChart = new ApexCharts(document.querySelector("#mainChart"), {
        series: [{
            name: 'Buy',
            data: []
        }, {
            name: 'Sell',
            data: []
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: { show: true }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '70%',
                dataLabels: {
                    position: 'top'
                }
            }
        },
        dataLabels: {
            enabled: true,
            offsetY: -20,
            style: {
                fontSize: '12px',
                colors: ["#304758"]
            }
        },
        colors: ['#28a745', '#dc3545'],
        xaxis: {
            categories: [],
            title: { text: 'Confidence Range' }
        },
        yaxis: {
            title: { text: 'Number of Signals' }
        },
        legend: {
            position: 'top'
        }
    });
    mainChart.render();

    timeframeChart = new ApexCharts(document.querySelector("#timeframeChart"), {
        series: [],
        chart: {
            type: 'donut',
            height: 300
        },
        labels: [],
        colors: ['#0d6efd', '#6610f2', '#6f42c1'],
        legend: {
            position: 'bottom'
        },
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return val.toFixed(1) + '%'
            }
        }
    });
    timeframeChart.render();
}

// Load data from API
async function loadData(timeframe = 'all') {
    try {
        const response = await fetch(`/api/live?timeframe=${timeframe}&limit=200`);
        const data = await response.json();
        
        if (response.ok) {
            allData = data;
            updateDashboard(data);
            updateLastRefresh();
        } else {
            showError(data.message || 'Failed to load data');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
}

// Update dashboard with data
function updateDashboard(data) {
    // Update stats
    const stats = data.stats || {};
    document.getElementById('buyCount').textContent = stats.buy_count || 0;
    document.getElementById('sellCount').textContent = stats.sell_count || 0;
    document.getElementById('holdCount').textContent = stats.hold_count || 0;
    document.getElementById('totalCount').textContent = data.count || 0;
    
    // Update source badge
    const source = data.source || 'Unknown';
    const isSupabase = source.includes('Supabase');
    document.getElementById('dataSourceBadge').textContent = isSupabase ? 'Supabase ML' : 'Yahoo TA';
    document.getElementById('dataSourceBadge').className = `badge ms-1 text-bg-${isSupabase ? 'success' : 'warning'}`;
    document.getElementById('tableSourceBadge').textContent = source;
    
    // Update system status
    updateSystemStatus(data);
    
    // Update hedge weights and probabilities
    updateHedgeWeights(data.ranked || []);
    updateProbabilities(data.ranked || []);
    
    // Update charts
    updateCharts(data.ranked || []);
    
    // Render table
    currentSignals = data.ranked || [];
    renderTable(currentSignals);
}

// Update system status indicators
function updateSystemStatus(data) {
    // Update predictions count
    document.getElementById('statusPredictions').textContent = (data.count || 0).toLocaleString();
    
    // Update universe size (estimate based on typical market size)
    document.getElementById('statusUniverse').textContent = '2,847';
    
    // Determine regime based on buy/sell ratio
    const stats = data.stats || {};
    const buyRatio = stats.buy_count / (stats.buy_count + stats.sell_count + 1);
    let regime = 'NEUTRAL';
    if (buyRatio > 0.6) regime = 'BULL';
    else if (buyRatio < 0.4) regime = 'BEAR';
    document.getElementById('statusRegime').textContent = regime;
}

// Update hedge weights from live data
function updateHedgeWeights(signals) {
    if (!signals || signals.length === 0) return;
    
    // Aggregate weights across all signals
    const weightMap = {};
    let totalSignals = 0;
    
    signals.forEach(s => {
        if (s.weights_json || s.weights) {
            const weights = s.weights_json || s.weights;
            Object.keys(weights).forEach(key => {
                if (!weightMap[key]) weightMap[key] = 0;
                weightMap[key] += weights[key];
            });
            totalSignals++;
        }
    });
    
    // Normalize and sort
    const weightArray = Object.keys(weightMap).map(key => ({
        name: key,
        weight: weightMap[key] / Math.max(totalSignals, 1)
    })).sort((a, b) => b.weight - a.weight).slice(0, 6);
    
    // Update method
    const method = signals[0]?.method || 'hedge';
    document.getElementById('hedgeMethod').textContent = method.toUpperCase();
    
    // Render weights
    const container = document.getElementById('hedgeWeightsContainer');
    if (weightArray.length === 0) {
        container.innerHTML = '<div class=\"text-muted text-center py-3\">No weights available</div>';
        return;
    }
    
    const totalWeight = weightArray.reduce((sum, w) => sum + w.weight, 0);
    container.innerHTML = weightArray.map((w, idx) => {
        const pct = (w.weight / totalWeight * 100).toFixed(1);
        return `
            <div class=\"d-flex align-items-center mb-2\">
                <div class=\"me-2 text-muted\" style=\"min-width: 30px;\">#${idx + 1}</div>
                <div class=\"flex-grow-1\">
                    <div class=\"d-flex justify-content-between mb-1\">
                        <span class=\"fw-bold\">${w.name.replace(/_/g, ' ')}</span>
                        <span class=\"badge text-bg-primary\">${pct}%</span>
                    </div>
                    <div class=\"progress\" style=\"height: 8px;\">
                        <div class=\"progress-bar bg-primary\" style=\"width: ${pct}%\"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Update probabilities from live data
function updateProbabilities(signals) {
    if (!signals || signals.length === 0) return;
    
    // Calculate average probabilities
    let totalAccept = 0, totalReject = 0, totalContinue = 0;
    let count = 0;
    
    signals.forEach(s => {
        if (s.p_accept !== undefined) {
            totalAccept += s.p_accept;
            totalReject += s.p_reject || 0;
            totalContinue += s.p_continue || 0;
            count++;
        }
    });
    
    if (count === 0) {
        document.getElementById('probabilitiesContainer').innerHTML = '<div class=\"text-muted text-center py-3\">No probability data</div>';
        return;
    }
    
    const avgAccept = (totalAccept / count * 100).toFixed(1);
    const avgReject = (totalReject / count * 100).toFixed(1);
    const avgContinue = (totalContinue / count * 100).toFixed(1);
    
    // Render probability breakdown
    document.getElementById('probabilitiesContainer').innerHTML = `
        <div class=\"mb-3\">
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-success\">P(ACCEPT)</span>
                <span class=\"badge text-bg-success\">${avgAccept}%</span>
            </div>
            <div class=\"progress mb-3\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-success\" style=\"width: ${avgAccept}%\">${avgAccept}%</div>
            </div>
            
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-danger\">P(REJECT)</span>
                <span class=\"badge text-bg-danger\">${avgReject}%</span>
            </div>
            <div class=\"progress mb-3\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-danger\" style=\"width: ${avgReject}%\">${avgReject}%</div>
            </div>
            
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-secondary\">P(CONTINUE)</span>
                <span class=\"badge text-bg-secondary\">${avgContinue}%</span>
            </div>
            <div class=\"progress\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-secondary\" style=\"width: ${avgContinue}%\">${avgContinue}%</div>
            </div>
        </div>
    `;
    
    // Add probability statistics
    document.getElementById('probabilityStats').innerHTML = `
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">High Conviction</div>
                <div class=\"fs-5 fw-bold text-success\">${signals.filter(s => s.p_accept > 0.7).length}</div>
                <div class=\"text-muted small\">>70% accept</div>
            </div>
        </div>
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">Medium</div>
                <div class=\"fs-5 fw-bold text-warning\">${signals.filter(s => s.p_accept >= 0.5 && s.p_accept <= 0.7).length}</div>
                <div class=\"text-muted small\">50-70%</div>
            </div>
        </div>
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">Low Conviction</div>
                <div class=\"fs-5 fw-bold text-danger\">${signals.filter(s => s.p_accept < 0.5).length}</div>
                <div class=\"text-muted small\"><50% accept</div>
            </div>
        </div>
    `;
}

// Update charts
function updateCharts(signals) {
    // Confidence distribution
    const buyByConf = { '60-70%': 0, '70-80%': 0, '80-90%': 0, '90-100%': 0 };
    const sellByConf = { '60-70%': 0, '70-80%': 0, '80-90%': 0, '90-100%': 0 };
    
    signals.forEach(s => {
        const conf = s.confidence * 100;
        let bucket;
        if (conf < 70) bucket = '60-70%';
        else if (conf < 80) bucket = '70-80%';
        else if (conf < 90) bucket = '80-90%';
        else bucket = '90-100%';
        
        if (s.signal === 'BUY') buyByConf[bucket]++;
        else if (s.signal === 'SELL') sellByConf[bucket]++;
    });
    
    mainChart.updateOptions({
        xaxis: { categories: Object.keys(buyByConf) },
        series: [{
            name: 'Buy',
            data: Object.values(buyByConf)
        }, {
            name: 'Sell',
            data: Object.values(sellByConf)
        }]
    });
    
    // Timeframe breakdown
    const tfCounts = allData.timeframe_counts || {};
    timeframeChart.updateOptions({
        labels: Object.keys(tfCounts),
        series: Object.values(tfCounts)
    });
}

// Render table
function renderTable(signals) {
    const tbody = document.getElementById('signalsTableBody');
    
    if (!signals || signals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">No signals available</td></tr>';
        return;
    }

    tbody.innerHTML = signals.map((s, idx) => {
        const signalClass = s.signal === 'BUY' ? 'table-success' : s.signal === 'SELL' ? 'table-danger' : '';
        const ticker = s.ticker || s.symbol || '--';
        const price = s.price ? `$${s.price.toFixed(2)}` : '--';
        const conf = (s.confidence * 100).toFixed(1);
        const confClass = conf >= 80 ? 'success' : conf >= 70 ? 'warning' : 'secondary';
        
        // Format date
        const dateStr = s.created_at ? new Date(s.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '--';
        
        // Probability (p_accept)
        const prob = s.p_accept ? (s.p_accept * 100).toFixed(1) : (s.probability ? (s.probability * 100).toFixed(1) : '--');
        const probClass = prob >= 70 ? 'success' : prob >= 60 ? 'warning' : 'secondary';
        
        // Calculate expected return %
        let expectedReturn = '--';
        if (s.price && s.tp1) {
            const returnPct = ((s.tp1 - s.price) / s.price * 100);
            expectedReturn = returnPct.toFixed(2) + '%';
        }
        const returnClass = expectedReturn !== '--' ? (parseFloat(expectedReturn) > 0 ? 'text-success' : 'text-danger') : '';
        
        const horizon = s.horizon_days ? `${s.horizon_days}d` : '--';
        const tp1 = s.tp1 ? `$${s.tp1.toFixed(2)}` : '--';
        const tp3 = s.tp3 ? `$${s.tp3.toFixed(2)}` : '--';
        const sl1 = s.sl1 ? `$${s.sl1.toFixed(2)}` : '--';
        const sl3 = s.sl3 ? `$${s.sl3.toFixed(2)}` : '--';
        const tf = s.plan_type || '--';
        
        return `
            <tr class="table-row-clickable ${signalClass}" data-index="${idx}">
                <td><strong><a href="https://agilera.ai/?symbol=${ticker}" target="_blank" style="color: inherit; text-decoration: none;">${ticker}</a></strong></td>
                <td class="text-muted small">${dateStr}</td>
                <td>
                    <span class="badge ${s.signal === 'BUY' ? 'text-bg-success' : s.signal === 'SELL' ? 'text-bg-danger' : 'text-bg-secondary'}">
                        ${s.signal}
                    </span>
                </td>
                <td class="price-cell">${price}</td>
                <td>
                    <span class="badge text-bg-${confClass} confidence-badge">${conf}%</span>
                </td>
                <td>
                    <span class="badge text-bg-${probClass}">${prob}%</span>
                </td>
                <td>${horizon}</td>
                <td class="fw-bold ${returnClass}">${expectedReturn}</td>
                <td class="text-success">${tp1}</td>
                <td class="text-success">${tp3}</td>
                <td class="text-danger">${sl1}</td>
                <td class="text-danger">${sl3}</td>
                <td><span class="badge text-bg-info">${tf}</span></td>
            </tr>
        `;
    }).join('');
}

// Sort table
let lastSortCol = null;
function sortTable(col) {
    if (sortColumn === col) {
        sortDirection *= -1;
    } else {
        sortColumn = col;
        sortDirection = -1;
        lastSortCol = col;
    }
    
    // Update header icons
    document.querySelectorAll('.sortable-header').forEach((th, idx) => {
        if (idx === col) {
            th.classList.add('active');
            th.querySelector('i').className = sortDirection === 1 ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
        } else {
            th.classList.remove('active');
            th.querySelector('i').className = 'bi bi-chevron-expand';
        }
    });
    
    const sorted = [...currentSignals].sort((a, b) => {
        let valA, valB;
        
        switch(col) {
            case 0: // Ticker
                valA = (a.ticker || a.symbol || '').toLowerCase(); 
                valB = (b.ticker || b.symbol || '').toLowerCase(); 
                return sortDirection * valA.localeCompare(valB);
            case 1: // Date
                valA = a.created_at ? new Date(a.created_at).getTime() : 0; 
                valB = b.created_at ? new Date(b.created_at).getTime() : 0; 
                return sortDirection * (valA - valB);
            case 2: // Signal
                valA = a.signal || ''; 
                valB = b.signal || ''; 
                return sortDirection * valA.localeCompare(valB);
            case 3: // Price
                valA = a.price || 0; 
                valB = b.price || 0; 
                return sortDirection * (valA - valB);
            case 4: // Confidence
                valA = a.confidence || 0; 
                valB = b.confidence || 0; 
                return sortDirection * (valA - valB);
            case 5: // Probability
                valA = a.p_accept || a.probability || 0; 
                valB = b.p_accept || b.probability || 0; 
                return sortDirection * (valA - valB);
            case 6: // Horizon
                valA = a.horizon_days || 0; 
                valB = b.horizon_days || 0; 
                return sortDirection * (valA - valB);
            case 7: // Expected %
                valA = (a.price && a.tp1) ? ((a.tp1 - a.price) / a.price * 100) : 0;
                valB = (b.price && b.tp1) ? ((b.tp1 - b.price) / b.price * 100) : 0;
                return sortDirection * (valA - valB);
            case 8: // TP1
                valA = a.tp1 || 0; 
                valB = b.tp1 || 0; 
                return sortDirection * (valA - valB);
            case 9: // TP3
                valA = a.tp3 || 0; 
                valB = b.tp3 || 0; 
                return sortDirection * (valA - valB);
            case 10: // SL1
                valA = a.sl1 || 0; 
                valB = b.sl1 || 0; 
                return sortDirection * (valA - valB);
            case 11: // SL3
                valA = a.sl3 || 0; 
                valB = b.sl3 || 0; 
                return sortDirection * (valA - valB);
            case 12: // Timeframe
                valA = a.plan_type || ''; 
                valB = b.plan_type || ''; 
                return sortDirection * valA.localeCompare(valB);
            default: 
                return 0;
        }
    });
    
    renderTable(sorted);
}

// Filter by timeframe
function filterTimeframe(tf) {
    // Update active nav
    document.querySelectorAll('.sidebar-menu .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target.closest('.nav-link').classList.add('active');
    
    loadData(tf);
}

// Show error
function showError(msg) {
    document.getElementById('signalsTableBody').innerHTML = `
        <tr><td colspan="10" class="text-center py-4">
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle"></i> ${msg}
            </div>
        </td></tr>
    `;
}

// Update last refresh
function updateLastRefresh() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
}

// Update refresh timer
let refreshCounter = 0;
function updateRefreshTimer() {
    refreshCounter++;
    if (refreshCounter >= 60) {
        refreshCounter = 0;
        loadData();
    }
    const remaining = 60 - refreshCounter;
    document.getElementById('refreshTimer').textContent = `${remaining}s`;
    
    // Update status bar countdown
    if (document.getElementById('statusRefresh')) {
        document.getElementById('statusRefresh').textContent = `${remaining}s`;
    }
    
    // Update UTC time
    if (document.getElementById('statusTime')) {
        const now = new Date();
        const utcTime = now.toISOString().substr(11, 8);
        document.getElementById('statusTime').textContent = utcTime;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadData();
    setInterval(updateRefreshTimer, 1000);
});
</script>

</body>
</html>
