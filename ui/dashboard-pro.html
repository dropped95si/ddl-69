<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DDL-69 Trading Dashboard | stazmediacorp.com</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- AdminLTE -->
    <link href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css" rel="stylesheet">
    <!-- ApexCharts -->
    <link href="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ink-900: #0b1220;
            --ink-800: #10192b;
            --ink-700: #162238;
            --ink-500: #5b6b86;
            --glow: rgba(88, 110, 255, 0.18);
            --accent: #5b7cfa;
            --accent-2: #3fd0c9;
            --panel: rgba(16, 25, 43, 0.9);
            --panel-border: rgba(82, 100, 140, 0.35);
            --text-hi: #eef2ff;
            --text-mid: #cbd5f5;
            --text-low: #93a4c6;
        }

        html, body {
            font-family: 'Sora', sans-serif;
            background: radial-gradient(circle at top left, #162038 0%, #0b1220 55%) fixed;
            color: var(--text-hi);
        }

        .app-header.navbar {
            background: rgba(10, 16, 30, 0.92);
            border-bottom: 1px solid var(--panel-border);
            box-shadow: 0 10px 30px rgba(10, 16, 30, 0.45);
        }

        .app-header .nav-link,
        .app-header .nav-link i {
            color: var(--text-mid);
        }

        .app-header .nav-link:hover {
            color: var(--text-hi);
        }

        .app-sidebar {
            background: linear-gradient(180deg, #0c1426 0%, #0e182e 100%);
            border-right: 1px solid var(--panel-border);
        }

        .app-sidebar .nav-link {
            color: var(--text-mid);
        }

        .app-sidebar .nav-link.active,
        .app-sidebar .nav-link:hover {
            background: rgba(88, 110, 255, 0.12);
            color: var(--text-hi);
        }

        .app-sidebar .nav-header {
            color: var(--text-low);
            letter-spacing: 0.1em;
        }

        .app-main {
            background: transparent;
        }

        .app-content-header h3,
        .app-content-header h1,
        .app-content-header h2 {
            color: var(--text-hi);
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            box-shadow: 0 16px 40px rgba(9, 13, 25, 0.45);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(82, 100, 140, 0.25);
            color: var(--text-hi);
        }

        .card .text-muted,
        .small,
        .text-muted {
            color: var(--text-low) !important;
        }

        .stat-box,
        .small-box {
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(9, 13, 25, 0.35);
        }

        .table {
            color: var(--text-hi);
        }

        .table thead th {
            background: rgba(22, 34, 56, 0.7);
            color: var(--text-mid);
            border-bottom: 1px solid var(--panel-border);
        }

        .table tbody tr {
            background: rgba(10, 16, 30, 0.6);
        }

        .table tbody tr:hover {
            background: rgba(88, 110, 255, 0.08) !important;
        }

        .badge.text-bg-info,
        .badge.text-bg-secondary,
        .badge.text-bg-success,
        .badge.text-bg-warning {
            border-radius: 999px;
            letter-spacing: 0.02em;
        }

        .price-cell {
            font-family: 'Space Mono', monospace;
        }

        .parent-strip-dashboard {
            background: linear-gradient(90deg, rgba(9, 13, 25, 0.95) 0%, rgba(14, 22, 40, 0.95) 60%, rgba(9, 13, 25, 0.95) 100%);
            border-bottom: 1px solid rgba(88, 110, 255, 0.18);
            box-shadow: inset 0 -1px 0 rgba(88, 110, 255, 0.08);
        }

        .parent-strip-dashboard .brand-pill {
            background: rgba(88, 110, 255, 0.2);
            border: 1px solid rgba(88, 110, 255, 0.35);
            color: #c7d2fe;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        .sortable-header i {
            opacity: 0.3;
            font-size: 0.8em;
        }
        .sortable-header.active i {
            opacity: 1;
        }
        .table-row-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .table-row-clickable:hover {
            background-color: #f8f9fa !important;
            transform: translateX(2px);
        }
        .confidence-badge {
            font-size: 0.9em;
            min-width: 60px;
        }
        .alert-strip {
            background: linear-gradient(90deg, rgba(142, 236, 210, 0.95), rgba(136, 213, 231, 0.95));
            color: #0b1220;
            padding: 10px 16px;
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .alert-strip .alert-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .alert-strip .alert-pill {
            background: rgba(11, 18, 32, 0.15);
            border: 1px solid rgba(11, 18, 32, 0.25);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .hero-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 24px;
            margin-bottom: 18px;
        }
        .hero-kicker {
            text-transform: uppercase;
            letter-spacing: 0.14em;
            font-size: 0.7rem;
            color: var(--text-low);
            margin-bottom: 6px;
        }
        .hero-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-hi);
        }
        .hero-sub {
            color: var(--text-mid);
            font-size: 0.95rem;
        }
        .status-strip {
            display: grid;
            grid-template-columns: repeat(6, minmax(90px, 1fr));
            gap: 10px;
        }
        .status-pill {
            background: rgba(16, 25, 43, 0.8);
            border: 1px solid rgba(88, 110, 255, 0.25);
            border-radius: 12px;
            padding: 8px 10px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(9, 13, 25, 0.35);
        }
        .status-pill .label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-low);
        }
        .status-pill .value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-hi);
        }
        @media (max-width: 1200px) {
            .status-strip {
                grid-template-columns: repeat(3, minmax(90px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .hero-head {
                flex-direction: column;
            }
            .status-strip {
                grid-template-columns: repeat(2, minmax(90px, 1fr));
                width: 100%;
            }
        }
    </style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
<div class="app-wrapper">

    <div class="alert-strip">
        <div>HIGH CONVICTION ALERTS</div>
        <div class="alert-pills">
            <span class="alert-pill" id="alertTicker1">--</span>
            <span class="alert-pill" id="alertTicker2">--</span>
            <span class="alert-pill" id="alertTicker3">--</span>
        </div>
    </div>

    <div class="parent-strip-dashboard">
        <div class="container-fluid parent-inner">
            <span class="brand-pill">AGILEra Stack</span>
            <span class="parent-links">
                <a href="https://stazmediacorp.com" target="_blank" rel="noopener">stazmediacorp.com</a>
                <span class="parent-sep">/</span>
                <a href="https://agilera.ai" target="_blank" rel="noopener">agilera.ai</a>
                <span class="parent-sep">/</span>
                <span class="parent-current">ddl-69</span>
            </span>
            <span class="parent-meta">Parent → Child</span>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                        <i class="bi bi-list"></i>
                    </a>
                </li>
                <li class="nav-item d-none d-md-block">
                    <a href="https://stazmediacorp.com" class="nav-link" target="_blank">
                        <i class="bi bi-house-door"></i> stazmediacorp.com
                    </a>
                </li>
                <li class="nav-item d-none d-md-block">
                    <a href="https://agilera.ai" class="nav-link" target="_blank">
                        <i class="bi bi-robot"></i> agilera.ai
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/audit" class="nav-link">
                        <i class="bi bi-graph-up-arrow"></i> Model Audit
                    </a>
                </li>
            </ul>
            
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="loadData(); return false;">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span id="refreshTimer" class="badge text-bg-secondary ms-1">--</span>
                    </a>
                </li>
                <li class="nav-item">
                    <span class="nav-link">
                        <i class="bi bi-database"></i>
                        <span id="dataSourceBadge" class="badge text-bg-info ms-1">Loading...</span>
                    </span>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand">
            <a href="/" class="brand-link">
                <span class="brand-text fw-light">DDL-69 v0.8</span>
            </a>
        </div>
        
        <div class="sidebar-wrapper">
            <nav class="mt-2">
                <ul class="nav sidebar-menu flex-column" role="navigation">
                    <li class="nav-header">SHORTCUTS</li>
                    <li class="nav-item">
                        <a href="/watchlist" class="nav-link">
                            <i class="bi bi-eye"></i>
                            <p>Watchlist</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <i class="bi bi-speedometer2"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/audit" class="nav-link">
                            <i class="bi bi-clipboard-data"></i>
                            <p>Model Audit</p>
                        </a>
                    </li>

                    <li class="nav-header">FILTERS</li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="filterTimeframe('all'); return false;">
                            <i class="bi bi-grid"></i>
                            <p>All Signals</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('day'); return false;">
                            <i class="bi bi-lightning"></i>
                            <p>Day Trading (1-30d)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('swing'); return false;">
                            <i class="bi bi-graph-up-arrow"></i>
                            <p>Swing Trading (1-12mo)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="filterTimeframe('long'); return false;">
                            <i class="bi bi-calendar-range"></i>
                            <p>Long Term (1y+)</p>
                        </a>
                    </li>
                    
                    <li class="nav-header">ANALYSIS</li>
                    <li class="nav-item">
                        <a href="/api/walkforward" class="nav-link" target="_blank">
                            <i class="bi bi-bar-chart-steps"></i>
                            <p>Walk-Forward Analysis</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/api/calibration" class="nav-link" target="_blank">
                            <i class="bi bi-speedometer2"></i>
                            <p>Calibration Data</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/api/events" class="nav-link" target="_blank">
                            <i class="bi bi-calendar-event"></i>
                            <p>Event Log</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-content-header">
            <div class="container-fluid">
                <div class="hero-head">
                    <div>
                        <div class="hero-kicker">DDL-69 · Probability Engine</div>
                        <div class="hero-title">Live Trading Signals</div>
                        <div class="hero-sub">Probabilities, regimes, and explainable weights — updated every 5 minutes</div>
                    </div>
                    <div class="status-strip">
                        <div class="status-pill">
                            <div class="label">Regime</div>
                            <div class="value" id="statusRegime">--</div>
                        </div>
                        <div class="status-pill">
                            <div class="label">Next Refresh</div>
                            <div class="value" id="statusRefresh">--</div>
                        </div>
                        <div class="status-pill">
                            <div class="label">UTC Time</div>
                            <div class="value" id="statusTime">--:--:--</div>
                        </div>
                        <div class="status-pill">
                            <div class="label">Universe</div>
                            <div class="value" id="statusUniverse">--</div>
                        </div>
                        <div class="status-pill">
                            <div class="label">Predictions</div>
                            <div class="value" id="statusPredictions">--</div>
                        </div>
                        <div class="status-pill">
                            <div class="label">Engine</div>
                            <div class="value">v0.8.4</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-content">
            <div class="container-fluid">
                
                <!-- Statistics Row -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-success">
                            <div class="inner">
                                <h3 id="buyCount">0</h3>
                                <p>Buy Signals</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4l8 8h-6v8h-4v-8H4l8-8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-danger">
                            <div class="inner">
                                <h3 id="sellCount">0</h3>
                                <p>Sell Signals</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 20l-8-8h6V4h4v8h6l-8 8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-warning">
                            <div class="inner">
                                <h3 id="holdCount">0</h3>
                                <p>Hold</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h12v4H6V4zm0 6h12v4H6v-4zm0 6h12v4H6v-4z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box text-bg-info">
                            <div class="inner">
                                <h3 id="totalCount">0</h3>
                                <p>Total</p>
                            </div>
                            <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-bar-chart"></i>
                                    Signal Distribution & Confidence
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="mainChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-pie-chart"></i>
                                    Timeframe Breakdown
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="timeframeChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-table"></i>
                                    Trading Signals
                                    <span id="tableSourceBadge" class="badge text-bg-secondary ms-2">--</span>
                                </h3>
                                <div class="card-tools">
                                    <span class="badge text-bg-primary" id="lastUpdate">--</span>
                                </div>
                            </div>
                            <div class="card-body table-responsive p-0">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" onclick="sortTable(0)">
                                                Ticker <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(1)">
                                                Date <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(2)">
                                                Signal <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(3)">
                                                Price <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(4)">
                                                Confidence <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(5)">
                                                Probability <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(6)">
                                                Horizon <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(7)">
                                                Expected % <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(8)">
                                                TP1 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(9)">
                                                TP3 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(10)">
                                                SL1 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(11)">
                                                SL3 <i class="bi bi-chevron-expand"></i>
                                            </th>
                                            <th class="sortable-header" onclick="sortTable(12)">
                                                Timeframe <i class="bi bi-chevron-expand"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="signalsTableBody">
                                        <tr>
                                            <td colspan="13" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Live Data Sections -->
    <div class="container-fluid mt-4 mb-4">
        <!-- Hedge Algorithm Weights & Probabilities Row -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-diagram-3-fill"></i> Live Hedge Weights</h5>
                        <span class="badge text-bg-success">Real-time from Supabase</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <div class="text-muted small">Algorithm: <strong class="text-dark">Multiplicative Weights Update (MWU)</strong></div>
                            <div class="text-muted small">Method: <strong id="hedgeMethod" class="text-primary">--</strong></div>
                        </div>
                        <div id="hedgeWeightsContainer" class="mt-3">
                            <div class="text-center text-muted py-3">Loading weights...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-pie-chart-fill"></i> Live Probabilities</h5>
                        <span class="badge text-bg-info">From ML Pipeline</span>
                    </div>
                    <div class="card-body">
                        <div id="probabilitiesContainer">
                            <div class="text-center text-muted py-3">Loading probabilities...</div>
                        </div>
                        <div class="row g-3 mt-2" id="probabilityStats">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">
            <span class="badge text-bg-success">v0.8</span>
            Powered by <a href="https://agilera.ai" target="_blank">agilera.ai</a>
        </div>
        <strong>&copy; 2026 <a href="https://stazmediacorp.com" target="_blank">stazmediacorp.com</a></strong>
    </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

<script>
let allData = [];
let currentSignals = [];
let sortColumn = 3; // Default: Confidence
let sortDirection = -1; // Descending
let mainChart, timeframeChart;
let refreshInterval;

// Initialize charts
function initCharts() {
    mainChart = new ApexCharts(document.querySelector("#mainChart"), {
        series: [{
            name: 'Buy',
            data: []
        }, {
            name: 'Sell',
            data: []
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: { show: true }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '70%',
                dataLabels: {
                    position: 'top'
                }
            }
        },
        dataLabels: {
            enabled: true,
            offsetY: -20,
            style: {
                fontSize: '12px',
                colors: ["#304758"]
            }
        },
        colors: ['#28a745', '#dc3545'],
        xaxis: {
            categories: [],
            title: { text: 'Confidence Range' }
        },
        yaxis: {
            title: { text: 'Number of Signals' }
        },
        legend: {
            position: 'top'
        }
    });
    mainChart.render();

    timeframeChart = new ApexCharts(document.querySelector("#timeframeChart"), {
        series: [],
        chart: {
            type: 'donut',
            height: 300
        },
        labels: [],
        colors: ['#0d6efd', '#6610f2', '#6f42c1'],
        legend: {
            position: 'bottom'
        },
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return val.toFixed(1) + '%'
            }
        }
    });
    timeframeChart.render();
}

// Load data from API
async function loadData(timeframe = 'all') {
    try {
        const response = await fetch(`/api/live?timeframe=${timeframe}&limit=200`);
        const data = await response.json();
        
        if (response.ok) {
            allData = data;
            updateDashboard(data);
            updateLastRefresh();
        } else {
            showError(data.message || 'Failed to load data');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
}

// Update dashboard with data
function updateDashboard(data) {
    // Update stats
    const stats = data.stats || {};
    document.getElementById('buyCount').textContent = stats.buy_count || 0;
    document.getElementById('sellCount').textContent = stats.sell_count || 0;
    document.getElementById('holdCount').textContent = stats.hold_count || 0;
    document.getElementById('totalCount').textContent = data.count || 0;
    
    // Update source badge
    const source = data.source || 'Unknown';
    const isSupabase = source.includes('Supabase');
    document.getElementById('dataSourceBadge').textContent = isSupabase ? 'Supabase ML' : 'Yahoo TA';
    document.getElementById('dataSourceBadge').className = `badge ms-1 text-bg-${isSupabase ? 'success' : 'warning'}`;
    document.getElementById('tableSourceBadge').textContent = source;
    
    // Update system status
    updateSystemStatus(data);
    
    // Update hedge weights and probabilities
    updateHedgeWeights(data.ranked || []);
    updateProbabilities(data.ranked || []);
    
    // Update charts
    updateCharts(data.ranked || []);
    
    // Render table
    currentSignals = data.ranked || [];
    renderTable(currentSignals);
}

// Update system status indicators
function updateSystemStatus(data) {
    // Update predictions count
    document.getElementById('statusPredictions').textContent = (data.count || 0).toLocaleString();
    
    // Update universe size (estimate based on typical market size)
    document.getElementById('statusUniverse').textContent = '2,847';
    
    // Determine regime based on buy/sell ratio
    const stats = data.stats || {};
    const buyRatio = stats.buy_count / (stats.buy_count + stats.sell_count + 1);
    let regime = 'NEUTRAL';
    if (buyRatio > 0.6) regime = 'BULL';
    else if (buyRatio < 0.4) regime = 'BEAR';
    document.getElementById('statusRegime').textContent = regime;

    const ranked = data.ranked || [];
    if (ranked.length > 0) {
        const top = ranked.slice(0, 3).map(r => r.ticker || r.symbol).filter(Boolean);
        document.getElementById('alertTicker1').textContent = top[0] || '--';
        document.getElementById('alertTicker2').textContent = top[1] || '--';
        document.getElementById('alertTicker3').textContent = top[2] || '--';
    }
}

// Update hedge weights from live data
function updateHedgeWeights(signals) {
    if (!signals || signals.length === 0) return;
    
    // Aggregate weights across all signals
    const weightMap = {};
    let totalSignals = 0;
    
    signals.forEach(s => {
        if (s.weights_json || s.weights) {
            const weights = s.weights_json || s.weights;
            Object.keys(weights).forEach(key => {
                if (!weightMap[key]) weightMap[key] = 0;
                weightMap[key] += weights[key];
            });
            totalSignals++;
        }
    });
    
    // Normalize and sort
    const weightArray = Object.keys(weightMap).map(key => ({
        name: key,
        weight: weightMap[key] / Math.max(totalSignals, 1)
    })).sort((a, b) => b.weight - a.weight).slice(0, 6);
    
    // Update method
    const method = signals[0]?.method || 'hedge';
    document.getElementById('hedgeMethod').textContent = method.toUpperCase();
    
    // Render weights
    const container = document.getElementById('hedgeWeightsContainer');
    if (weightArray.length === 0) {
        container.innerHTML = '<div class=\"text-muted text-center py-3\">No weights available</div>';
        return;
    }
    
    const totalWeight = weightArray.reduce((sum, w) => sum + w.weight, 0);
    container.innerHTML = weightArray.map((w, idx) => {
        const pct = (w.weight / totalWeight * 100).toFixed(1);
        return `
            <div class=\"d-flex align-items-center mb-2\">
                <div class=\"me-2 text-muted\" style=\"min-width: 30px;\">#${idx + 1}</div>
                <div class=\"flex-grow-1\">
                    <div class=\"d-flex justify-content-between mb-1\">
                        <span class=\"fw-bold\">${w.name.replace(/_/g, ' ')}</span>
                        <span class=\"badge text-bg-primary\">${pct}%</span>
                    </div>
                    <div class=\"progress\" style=\"height: 8px;\">
                        <div class=\"progress-bar bg-primary\" style=\"width: ${pct}%\"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Update probabilities from live data
function updateProbabilities(signals) {
    if (!signals || signals.length === 0) return;
    
    // Calculate average probabilities
    let totalAccept = 0, totalReject = 0, totalContinue = 0;
    let count = 0;
    
    signals.forEach(s => {
        if (s.p_accept !== undefined) {
            totalAccept += s.p_accept;
            totalReject += s.p_reject || 0;
            totalContinue += s.p_continue || 0;
            count++;
        }
    });
    
    if (count === 0) {
        document.getElementById('probabilitiesContainer').innerHTML = '<div class=\"text-muted text-center py-3\">No probability data</div>';
        return;
    }
    
    const avgAccept = (totalAccept / count * 100).toFixed(1);
    const avgReject = (totalReject / count * 100).toFixed(1);
    const avgContinue = (totalContinue / count * 100).toFixed(1);
    
    // Render probability breakdown
    document.getElementById('probabilitiesContainer').innerHTML = `
        <div class=\"mb-3\">
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-success\">P(ACCEPT)</span>
                <span class=\"badge text-bg-success\">${avgAccept}%</span>
            </div>
            <div class=\"progress mb-3\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-success\" style=\"width: ${avgAccept}%\">${avgAccept}%</div>
            </div>
            
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-danger\">P(REJECT)</span>
                <span class=\"badge text-bg-danger\">${avgReject}%</span>
            </div>
            <div class=\"progress mb-3\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-danger\" style=\"width: ${avgReject}%\">${avgReject}%</div>
            </div>
            
            <div class=\"d-flex justify-content-between mb-2\">
                <span class=\"text-secondary\">P(CONTINUE)</span>
                <span class=\"badge text-bg-secondary\">${avgContinue}%</span>
            </div>
            <div class=\"progress\" style=\"height: 25px;\">
                <div class=\"progress-bar bg-secondary\" style=\"width: ${avgContinue}%\">${avgContinue}%</div>
            </div>
        </div>
    `;
    
    // Add probability statistics
    document.getElementById('probabilityStats').innerHTML = `
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">High Conviction</div>
                <div class=\"fs-5 fw-bold text-success\">${signals.filter(s => s.p_accept > 0.7).length}</div>
                <div class=\"text-muted small\">>70% accept</div>
            </div>
        </div>
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">Medium</div>
                <div class=\"fs-5 fw-bold text-warning\">${signals.filter(s => s.p_accept >= 0.5 && s.p_accept <= 0.7).length}</div>
                <div class=\"text-muted small\">50-70%</div>
            </div>
        </div>
        <div class=\"col-4\">
            <div class=\"text-center\">
                <div class=\"text-muted small\">Low Conviction</div>
                <div class=\"fs-5 fw-bold text-danger\">${signals.filter(s => s.p_accept < 0.5).length}</div>
                <div class=\"text-muted small\"><50% accept</div>
            </div>
        </div>
    `;
}

// Update charts
function updateCharts(signals) {
    // Confidence distribution
    const buyByConf = { '60-70%': 0, '70-80%': 0, '80-90%': 0, '90-100%': 0 };
    const sellByConf = { '60-70%': 0, '70-80%': 0, '80-90%': 0, '90-100%': 0 };
    
    signals.forEach(s => {
        const conf = s.confidence * 100;
        let bucket;
        if (conf < 70) bucket = '60-70%';
        else if (conf < 80) bucket = '70-80%';
        else if (conf < 90) bucket = '80-90%';
        else bucket = '90-100%';
        
        if (s.signal === 'BUY') buyByConf[bucket]++;
        else if (s.signal === 'SELL') sellByConf[bucket]++;
    });
    
    mainChart.updateOptions({
        xaxis: { categories: Object.keys(buyByConf) },
        series: [{
            name: 'Buy',
            data: Object.values(buyByConf)
        }, {
            name: 'Sell',
            data: Object.values(sellByConf)
        }]
    });
    
    // Timeframe breakdown
    const tfCounts = allData.timeframe_counts || {};
    timeframeChart.updateOptions({
        labels: Object.keys(tfCounts),
        series: Object.values(tfCounts)
    });
}

// Render table
function renderTable(signals) {
    const tbody = document.getElementById('signalsTableBody');
    
    if (!signals || signals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">No signals available</td></tr>';
        return;
    }

    tbody.innerHTML = signals.map((s, idx) => {
        const signalClass = s.signal === 'BUY' ? 'table-success' : s.signal === 'SELL' ? 'table-danger' : '';
        const ticker = s.ticker || s.symbol || '--';
        const price = s.price ? `$${s.price.toFixed(2)}` : '--';
        const conf = (s.confidence * 100).toFixed(1);
        const confClass = conf >= 80 ? 'success' : conf >= 70 ? 'warning' : 'secondary';
        
        // Format date
        const dateStr = s.created_at ? new Date(s.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '--';
        
        // Probability (p_accept)
        const prob = s.p_accept ? (s.p_accept * 100).toFixed(1) : (s.probability ? (s.probability * 100).toFixed(1) : '--');
        const probClass = prob >= 70 ? 'success' : prob >= 60 ? 'warning' : 'secondary';
        
        // Use probability-weighted expected return from API
        let expectedReturn = '--';
        if (s.expected_return_pct !== undefined && s.expected_return_pct !== null) {
            expectedReturn = (s.expected_return_pct > 0 ? '+' : '') + s.expected_return_pct.toFixed(2) + '%';
        }
        const returnClass = expectedReturn !== '--' ? (parseFloat(expectedReturn) > 0 ? 'text-success' : 'text-danger') : '';
        
        const horizon = s.horizon_days ? `${s.horizon_days}d` : '--';
        const tp1 = s.tp1 ? `$${s.tp1.toFixed(2)}` : '--';
        const tp3 = s.tp3 ? `$${s.tp3.toFixed(2)}` : '--';
        const sl1 = s.sl1 ? `$${s.sl1.toFixed(2)}` : '--';
        const sl3 = s.sl3 ? `$${s.sl3.toFixed(2)}` : '--';
        const tf = s.plan_type || '--';
        
        return `
            <tr class="table-row-clickable ${signalClass}" data-index="${idx}">
                <td><strong><a href="https://agilera.ai/?symbol=${ticker}" target="_blank" style="color: inherit; text-decoration: none;">${ticker}</a></strong></td>
                <td class="text-muted small">${dateStr}</td>
                <td>
                    <span class="badge ${s.signal === 'BUY' ? 'text-bg-success' : s.signal === 'SELL' ? 'text-bg-danger' : 'text-bg-secondary'}">
                        ${s.signal}
                    </span>
                </td>
                <td class="price-cell">${price}</td>
                <td>
                    <span class="badge text-bg-${confClass} confidence-badge">${conf}%</span>
                </td>
                <td>
                    <span class="badge text-bg-${probClass}">${prob}%</span>
                </td>
                <td>${horizon}</td>
                <td class="fw-bold ${returnClass}">${expectedReturn}</td>
                <td class="text-success">${tp1}</td>
                <td class="text-success">${tp3}</td>
                <td class="text-danger">${sl1}</td>
                <td class="text-danger">${sl3}</td>
                <td><span class="badge text-bg-info">${tf}</span></td>
            </tr>
        `;
    }).join('');
}

// Sort table
let lastSortCol = null;
function sortTable(col) {
    if (sortColumn === col) {
        sortDirection *= -1;
    } else {
        sortColumn = col;
        sortDirection = -1;
        lastSortCol = col;
    }
    
    // Update header icons
    document.querySelectorAll('.sortable-header').forEach((th, idx) => {
        if (idx === col) {
            th.classList.add('active');
            th.querySelector('i').className = sortDirection === 1 ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
        } else {
            th.classList.remove('active');
            th.querySelector('i').className = 'bi bi-chevron-expand';
        }
    });
    
    const sorted = [...currentSignals].sort((a, b) => {
        let valA, valB;
        
        switch(col) {
            case 0: // Ticker
                valA = (a.ticker || a.symbol || '').toLowerCase(); 
                valB = (b.ticker || b.symbol || '').toLowerCase(); 
                return sortDirection * valA.localeCompare(valB);
            case 1: // Date
                valA = a.created_at ? new Date(a.created_at).getTime() : 0; 
                valB = b.created_at ? new Date(b.created_at).getTime() : 0; 
                return sortDirection * (valA - valB);
            case 2: // Signal
                valA = a.signal || ''; 
                valB = b.signal || ''; 
                return sortDirection * valA.localeCompare(valB);
            case 3: // Price
                valA = a.price || 0; 
                valB = b.price || 0; 
                return sortDirection * (valA - valB);
            case 4: // Confidence
                valA = a.confidence || 0; 
                valB = b.confidence || 0; 
                return sortDirection * (valA - valB);
            case 5: // Probability
                valA = a.p_accept || a.probability || 0; 
                valB = b.p_accept || b.probability || 0; 
                return sortDirection * (valA - valB);
            case 6: // Horizon
                valA = a.horizon_days || 0; 
                valB = b.horizon_days || 0; 
                return sortDirection * (valA - valB);
            case 7: // Expected %
                valA = a.expected_return_pct || 0;
                valB = b.expected_return_pct || 0;
                return sortDirection * (valA - valB);
            case 8: // TP1
                valA = a.tp1 || 0; 
                valB = b.tp1 || 0; 
                return sortDirection * (valA - valB);
            case 9: // TP3
                valA = a.tp3 || 0; 
                valB = b.tp3 || 0; 
                return sortDirection * (valA - valB);
            case 10: // SL1
                valA = a.sl1 || 0; 
                valB = b.sl1 || 0; 
                return sortDirection * (valA - valB);
            case 11: // SL3
                valA = a.sl3 || 0; 
                valB = b.sl3 || 0; 
                return sortDirection * (valA - valB);
            case 12: // Timeframe
                valA = a.plan_type || ''; 
                valB = b.plan_type || ''; 
                return sortDirection * valA.localeCompare(valB);
            default: 
                return 0;
        }
    });
    
    renderTable(sorted);
}

// Filter by timeframe
function filterTimeframe(tf) {
    // Update active nav
    document.querySelectorAll('.sidebar-menu .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target.closest('.nav-link').classList.add('active');
    
    loadData(tf);
}

// Show error
function showError(msg) {
    document.getElementById('signalsTableBody').innerHTML = `
        <tr><td colspan="10" class="text-center py-4">
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle"></i> ${msg}
            </div>
        </td></tr>
    `;
}

// Update last refresh
function updateLastRefresh() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
}

// Update refresh timer
let refreshCounter = 0;
function updateRefreshTimer() {
    refreshCounter++;
    if (refreshCounter >= 60) {
        refreshCounter = 0;
        loadData();
    }
    const remaining = 60 - refreshCounter;
    document.getElementById('refreshTimer').textContent = `${remaining}s`;
    
    // Update status bar countdown
    if (document.getElementById('statusRefresh')) {
        document.getElementById('statusRefresh').textContent = `${remaining}s`;
    }
    
    // Update UTC time
    if (document.getElementById('statusTime')) {
        const now = new Date();
        const utcTime = now.toISOString().substr(11, 8);
        document.getElementById('statusTime').textContent = utcTime;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadData();
    setInterval(updateRefreshTimer, 1000);
});
</script>

</body>
</html>
