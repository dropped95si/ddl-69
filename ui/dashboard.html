<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>DDL-69 ‚Äî Detailed Trading Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      body { padding: 10px; font-size: 14px; }
      h1 { font-size: 1.8em !important; }
      .subtitle { font-size: 0.9em !important; }
      .controls { gap: 5px !important; }
      button { padding: 8px 16px !important; font-size: 0.9em !important; }
      .stats-bar { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
      .stat-value { font-size: 1.4em !important; }
      .grid { grid-template-columns: 1fr !important; gap: 15px !important; }
      .card { padding: 15px !important; }
      .symbol { font-size: 1.3em !important; }
      .price-large { font-size: 1.5em !important; }
      .targets-stoploss { flex-direction: column !important; }
      .target-group, .sl-group { width: 100% !important; }
    }
    @media (max-width: 480px) {
      body { padding: 5px; }
      h1 { font-size: 1.5em !important; }
      .stats-bar { gap: 8px !important; }
      .stat-item { padding: 10px !important; }
      .metrics-section { grid-template-columns: repeat(2, 1fr) !important; }
    }
    
    header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeIn 0.6s ease;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #00d4ff, #0099ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { font-size: 1.1em; color: #aaa; }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #00d4ff, #0099ff);
      color: #000;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3); }
    .btn-primary:active { transform: translateY(0); }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
    
    .status {
      text-align: center;
      margin-bottom: 30px;
      font-size: 0.95em;
      color: #0f0;
    }
    .status.error { color: #ff4444; }
    .status.loading { color: #ffaa00; }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .stat-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .stat-label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; }
    .stat-value { font-size: 1.8em; font-weight: bold; color: #00d4ff; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s ease;
      animation: slideUp 0.5s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .card:hover {
      background: rgba(255, 255, 255, 0.07);
      border-color: rgba(0, 212, 255, 0.5);
      transform: translateY(-5px);
      box-shadow: 0 20px 50px rgba(0, 212, 255, 0.15);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 15px;
    }
    
    .symbol-section {
      flex: 1;
    }
    .symbol { font-size: 1.8em; font-weight: bold; color: #00d4ff; }
    .name { font-size: 0.9em; color: #aaa; margin-top: 4px; }
    
    .signal-badge {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
      text-transform: uppercase;
    }
    .signal-buy { background: #00aa00; color: #fff; }
    .signal-hold { background: #ff8800; color: #fff; }
    .signal-sell { background: #cc0000; color: #fff; }
    
    .price-section {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .price-large { font-size: 1.5em; font-weight: bold; color: #fff; }
    .price-change {
      font-size: 1em;
      font-weight: bold;
    }
    .price-change.positive { color: #00ff00; }
    .price-change.negative { color: #ff4444; }
    
    .metrics-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric-label { font-size: 0.85em; color: #aaa; }
    .metric-value { font-size: 1.1em; font-weight: bold; color: #00d4ff; }
    
    .targets-stoploss {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .target-group, .sl-group {
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .target-group { border-left: 3px solid #00ff00; }
    .sl-group { border-left: 3px solid #ff4444; }
    
    .group-title {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #aaa;
      margin-bottom: 8px;
    }
    
    .level {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      margin: 5px 0;
    }
    .level-label { color: #aaa; }
    .level-value { font-weight: bold; color: #fff; }
    .target-group .level-value { color: #00ff00; }
    .sl-group .level-value { color: #ff4444; }
    
    .reasoning {
      background: rgba(0, 200, 255, 0.05);
      border-left: 3px solid #0088ff;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #ccc;
      line-height: 1.5;
    }
    
    .weights {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 0;
    }
    
    .weight-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85em;
      padding: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }
    
    .weight-label { color: #aaa; }
    .weight-value { font-weight: bold; color: #00d4ff; }
    
    input[type="file"] { display: none; }
    .file-label {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-label:hover { background: rgba(255, 255, 255, 0.15); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ DDL-69 Dashboard</h1>
      <p class="subtitle">Detailed Trade Signals with TP/SL Levels</p>
    </header>

    <div class="controls">
      <button class="btn-primary" onclick="loadLiveData()">üìä Load Live</button>
      <button class="btn-secondary" onclick="loadLiveData()">üî¥ Refresh Live</button>
      <label class="file-label">
        üìÅ Upload CSV/JSON
        <input type="file" id="fileUpload" onchange="handleFileUpload(event)">
      </label>
    </div>

    <div class="status" id="status"></div>

    <div class="stats-bar" id="statsBar"></div>

    <div class="grid" id="watchlist"></div>
  </div>

  <script>
    function esc(str) {
        const d = document.createElement('div');
        d.appendChild(document.createTextNode(String(str ?? '')));
        return d.innerHTML;
    }

    const CACHE_KEY = 'ddl69_cache';
    const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

    function showStatus(msg, type = 'status') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + type;
    }

    function getCache() {
      const cached = localStorage.getItem(CACHE_KEY);
      if (!cached) return null;
      const { data, timestamp } = JSON.parse(cached);
      const age = Date.now() - timestamp;
      if (age > CACHE_TTL) {
        localStorage.removeItem(CACHE_KEY);
        return null;
      }
      const remaining = Math.ceil((CACHE_TTL - age) / 1000);
      showStatus(`‚úÖ Cached data (expires in ${remaining}s)`);
      return data;
    }

    function setCache(data) {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
    }

    async function loadLiveData() {
      showStatus('Fetching live data...', 'loading');
      const cached = getCache();
      if (cached) {
        renderData(cached);
        return;
      }
      try {
        const response = await fetch('/api/live');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        if (result.data) {
          setCache(result.data);
          renderData(result.data);
        }
      } catch (error) {
        showStatus('‚ùå Live failed: ' + error.message, 'error');
        if (cached) renderData(cached);
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          let data;
          if (file.name.endsWith('.json')) {
            data = JSON.parse(e.target.result);
            renderData(data.data || data);
          } else if (file.name.endsWith('.csv')) {
            const watchlist = parseCSV(e.target.result);
            renderData({ watchlist, stats: { total_symbols: watchlist.length } });
          }
          showStatus('‚úÖ File loaded');
        } catch (err) {
          showStatus('‚ùå Parse error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const symbolIdx = headers.indexOf('symbol');
      const priceIdx = headers.indexOf('price');
      const scoreIdx = headers.indexOf('score');
      const probIdx = headers.indexOf('probability');

      return lines.slice(1).map(line => {
        const parts = [];
        let current = '';
        let inQuotes = false;
        for (let char of line) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) {
            parts.push(current.trim().replace(/"/g, ''));
            current = '';
          } else current += char;
        }
        parts.push(current.trim().replace(/"/g, ''));

        return {
          symbol: symbolIdx >= 0 ? parts[symbolIdx] || 'N/A' : 'N/A',
          price: priceIdx >= 0 ? parseFloat(parts[priceIdx]) || 0 : 0,
          score: scoreIdx >= 0 ? parseFloat(parts[scoreIdx]) || 0.5 : 0.5,
          probability: probIdx >= 0 ? parseFloat(parts[probIdx]) || 0.5 : 0.5,
          name: 'Manual Entry',
          signal: 'HOLD',
          reasoning: 'Data from CSV upload',
        };
      });
    }

    function renderData(data) {
      if (!data || !data.watchlist) {
        showStatus('‚ùå Invalid data format', 'error');
        return;
      }

      renderStats(data.stats || {});
      renderWatchlist(data.watchlist || []);
      showStatus('‚úÖ Data loaded successfully');
    }

    function renderStats(stats) {
      const html = `
        <div class="stat-item">
          <div class="stat-label">Total Symbols</div>
          <div class="stat-value">${stats.total_symbols || 0}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Avg Score</div>
          <div class="stat-value">${((stats.avg_score || 0) * 100).toFixed(0)}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Avg Confidence</div>
          <div class="stat-value">${((stats.avg_confidence || 0) * 100).toFixed(0)}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">BUY</div>
          <div class="stat-value" style="color: #00ff00;">${stats.buy_count || 0}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">HOLD</div>
          <div class="stat-value" style="color: #ffaa00;">${stats.hold_count || 0}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">SELL</div>
          <div class="stat-value" style="color: #ff4444;">${stats.sell_count || 0}</div>
        </div>
      `;
      document.getElementById('statsBar').innerHTML = html;
    }

    function renderWatchlist(items) {
      const html = items.map(item => {
        const signal = item.signal || 'HOLD';
        const signalClass = `signal-${signal.toLowerCase()}`;
        const changeClass = (item.change || 0) >= 0 ? 'positive' : 'negative';
        const changeSign = (item.change || 0) >= 0 ? '+' : '';
        const targets = item.targets || {};
        const stoploss = item.stoploss || {};
        const reasoning = item.reasoning || 'No reasoning available';
        const confidence = (item.confidence || 0.5);
        const probability = (item.probability || 0.5);
        const weights = item.weights || {};

        return `
          <div class="card">
            <div class="card-header">
              <div class="symbol-section">
                <div class="symbol">${esc(item.symbol || 'N/A')}</div>
                <div class="name">${esc(item.name || 'Unknown')}</div>
              </div>
              <div class="signal-badge ${signalClass}">${esc(signal)}</div>
            </div>

            <div class="price-section">
              <div>
                <div class="price-large">$${(item.price || 0).toFixed(2)}</div>
              </div>
              <div class="price-change ${changeClass}">
                ${changeSign}${(item.change || 0).toFixed(2)}%
              </div>
            </div>

            <div class="metrics-section">
              <div class="metric">
                <span class="metric-label">Score</span>
                <span class="metric-value">${((item.score || 0) * 100).toFixed(0)}%</span>
              </div>
              <div class="metric">
                <span class="metric-label">Confidence</span>
                <span class="metric-value">${(confidence * 100).toFixed(0)}%</span>
              </div>
              <div class="metric">
                <span class="metric-label">Probability</span>
                <span class="metric-value">${(probability * 100).toFixed(0)}%</span>
              </div>
              <div class="metric">
                <span class="metric-label">Risk/Reward</span>
                <span class="metric-value">${(((targets.tp1 || item.price) - item.price) / Math.max((item.price - (stoploss.sl1 || item.price)), 0.01)).toFixed(2)}x</span>
              </div>
            </div>

            <div class="targets-stoploss">
              <div class="target-group">
                <div class="group-title">üìà Take Profit</div>
                ${targets.tp1 ? `<div class="level"><span class="level-label">TP1</span><span class="level-value">$${targets.tp1.toFixed(2)}</span></div>` : ''}
                ${targets.tp2 ? `<div class="level"><span class="level-label">TP2</span><span class="level-value">$${targets.tp2.toFixed(2)}</span></div>` : ''}
                ${targets.tp3 ? `<div class="level"><span class="level-label">TP3</span><span class="level-value">$${targets.tp3.toFixed(2)}</span></div>` : ''}
              </div>
              <div class="sl-group">
                <div class="group-title">üõë Stop Loss</div>
                ${stoploss.sl1 ? `<div class="level"><span class="level-label">SL1</span><span class="level-value">$${stoploss.sl1.toFixed(2)}</span></div>` : ''}
                ${stoploss.sl2 ? `<div class="level"><span class="level-label">SL2</span><span class="level-value">$${stoploss.sl2.toFixed(2)}</span></div>` : ''}
                ${stoploss.sl3 ? `<div class="level"><span class="level-label">SL3</span><span class="level-value">$${stoploss.sl3.toFixed(2)}</span></div>` : ''}
              </div>
            </div>

            <div class="reasoning">
              <strong>Why:</strong> ${esc(reasoning)}
            </div>

            ${Object.keys(weights).length > 0 ? `
              <div style="padding-top: 12px;">
                <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; color: #aaa; margin-bottom: 8px;">Model Weights</div>
                <div class="weights">
                  ${Object.entries(weights).map(([key, val]) => `
                    <div class="weight-item">
                      <span class="weight-label">${esc(key)}</span>
                      <span class="weight-value">${(val * 100).toFixed(0)}%</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      document.getElementById('watchlist').innerHTML = html;
    }

    // Load live data on page load
    window.addEventListener('load', loadLiveData);
  </script>
</body>
</html>
